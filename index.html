<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Wallet</title>
    <style>
        /* --- RESET & BASIC STYLES --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            overflow: hidden;
            position: relative;
        }

        /* --- LOGIN SCREEN --- */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            color: #333;
            width: 90%;
            max-width: 400px;
        }

        .btn-google {
            background: #4285F4;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn-google:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4);
        }

        /* --- APP STYLES --- */
        h1 {
            color: #3f2b96;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .btn-logout {
            background: #ff7675;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 11px;
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .nav-btn.home {
            background: linear-gradient(to right, #667eea, #764ba2);
        }

        .nav-btn.history {
            background: linear-gradient(to right, #11998e, #38ef7d);
        }

        .nav-btn.borrow {
            background: linear-gradient(to right, #ff9966, #ff5e62);
        }

        .nav-btn.wishlist {
            background: linear-gradient(to right, #8e44ad, #9b59b6);
        }

        .nav-btn.events {
            background: linear-gradient(to right, #e17055, #fab1a0);
        }

        .budget-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            color: white;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: center;
        }

        .budget-item p {
            font-size: 48px;
            font-weight: bold;
        }

        .remaining.negative {
            color: #ffcccc !important;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .debt-alert-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid rgba(255, 100, 100, 0.5);
            animation: pulse 2s infinite;
        }

        .debt-text {
            color: #ffcccc;
            font-size: 32px !important;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 100, 100, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 100, 100, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 100, 100, 0);
            }
        }

        .expense-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid #eef2f7;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .add-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .expenses-list {
            margin-top: 30px;
        }

        .expense-item {
            background: white;
            border: 1px solid #eef2f7;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .expense-amount {
            font-size: 18px;
            font-weight: bold;
            margin: 0 20px;
            min-width: 80px;
            text-align: right;
        }

        .btn-small {
            padding: 8px 12px;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-delete {
            background: #ff7675;
        }

        .btn-action {
            background: #00b894;
        }

        .btn-export {
            background: #27ae60;
            margin-left: 10px;
        }

        .wishlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .wishlist-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }

        .wishlist-img-box {
            width: 100%;
            height: 150px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wishlist-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .wishlist-content {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .btn-buy {
            flex: 1;
            background: #8e44ad;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .purchased-badge {
            background: #00b894;
            color: white;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .card-purchased {
            opacity: 0.7;
            filter: grayscale(100%);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-borrowed {
            background: #ffeaa7;
            color: #d35400;
        }

        .badge-lent {
            background: #74b9ff;
            color: #0984e3;
        }

        .badge-paid {
            background: #55efc4;
            color: #00b894;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .card-borrowed {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
        }

        .card-lent {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }
    </style>
</head>

<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="margin-bottom: 20px;">Student Wallet</h2>
            <p style="margin-bottom: 30px; color: #666;">Sign in to track your allowance and costs.</p>
            <button class="btn-google" onclick="googleLogin()">
                <svg width="20" height="20" viewBox="0 0 24 24" style="margin-right: 10px">
                    <path fill="currentColor"
                        d="M21.35 11.1h-9.17v2.98h5.24c-.27 1.67-1.65 4.54-5.24 4.54-3.15 0-5.73-2.55-5.73-5.73s2.55-5.73 5.73-5.73c1.38 0 2.62.5 3.58 1.45l2.4-2.4c-1.63-1.54-3.75-2.47-5.98-2.47-4.96 0-9 4.04-9 9s4.04 9 9 9c5.21 0 8.66-3.66 8.66-8.8 0-.68-.07-1.35-.15-1.99z" />
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <div class="user-info">
            <span id="userEmail">student@email.com</span>
            <button class="btn-logout" onclick="logout()">Sign Out</button>
        </div>

        <h1>üéì Toushik's Wallet</h1>

        <div class="nav-buttons">
            <button onclick="showPage('home')" class="nav-btn home">Dashboard</button>
            <button onclick="showPage('events')" class="nav-btn events">Events/Tour</button>
            <button onclick="showPage('wishlist')" class="nav-btn wishlist">Wishlist</button>
            <button onclick="showPage('borrow')" class="nav-btn borrow">Dhar/Loan</button>
            <button onclick="showPage('history')" class="nav-btn history">History</button>
        </div>

        <div id="homePage">
            <div style="text-align: center; margin-bottom: 20px;">
                <input type="date" id="mainDate" style="padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            <div class="budget-section">
                <div class="budget-grid">
                    <div class="budget-item">
                        <h3>My Pocket Balance</h3>
                        <p id="remaining">Loading...</p>
                    </div>
                    <div class="budget-item debt-alert-box" id="dashboardDebtBox" style="display: none;">
                        <h3>‚ö†Ô∏è You Owe</h3>
                        <p id="dashboardDebt" class="debt-text">‡ß≥0.00</p>
                    </div>
                </div>
            </div>
            <div class="expense-form">
                <h3 style="margin-bottom: 15px;">Wallet Entry</h3>
                <div class="form-group">
                    <select id="transactionType">
                        <option value="income">Money Received</option>
                        <option value="expense">Spent (Cost)</option>
                    </select>
                </div>
                <div class="form-group"><input type="text" id="transactionDesc"
                        placeholder="Description (e.g. Pocket money, Rickshaw)"></div>
                <div class="form-group"><input type="number" id="transactionAmount" placeholder="Amount"></div>
                <button class="add-btn" onclick="addMainTransaction()">Submit</button>
            </div>
        </div>

        <div id="eventsPage" style="display: none;">
            <div id="eventListView">
                <div class="expense-form" style="border-left: 5px solid #e17055;">
                    <h3 style="color: #d35400; margin-bottom: 15px;">New Tour / Event</h3>
                    <div class="form-group"><input type="text" id="newEventName"
                            placeholder="Event Name (e.g. Sajek Tour)"></div>
                    <div class="form-group"><input type="number" id="newEventBudget"
                            placeholder="Initial Money Taken (Abbu/Saved)"></div>
                    <button class="add-btn" onclick="createNewEvent()" style="background: #e17055;">Create
                        Event</button>
                </div>
                <h3 style="margin: 20px 0;">Active Events</h3>
                <div id="activeEventsList" class="wishlist-grid"></div>

                <h3 style="margin: 20px 0; color: #aaa;">Completed History</h3>
                <div id="completedEventsList" class="wishlist-grid"></div>
            </div>

            <div id="eventDetailView" style="display: none;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <button onclick="closeEventView()" class="btn-small" style="background: #aaa;">‚Üê Back to
                        List</button>
                    <div>
                        <button onclick="deleteCurrentEvent()" class="btn-small"
                            style="background: #c0392b; margin-right: 5px;">Delete Event</button>
                        <button onclick="generateEventPDF()" class="btn-small btn-action">Download PDF</button>
                    </div>
                </div>

                <div class="budget-section" style="background: linear-gradient(135deg, #e17055 0%, #fab1a0 100%);">
                    <h2 id="currentEventTitle">Event Name</h2>
                    <div class="budget-grid">
                        <div>
                            <small>Funds in Hand</small>
                            <p id="eventBalance">‡ß≥0</p>
                        </div>
                        <div>
                            <small>Total Spent</small>
                            <p id="eventSpent">‡ß≥0</p>
                        </div>
                    </div>
                    <button id="btnCompleteEvent" onclick="completeEvent()" class="btn-small"
                        style="background: white; color: #d35400; margin-top: 10px; font-weight: bold; padding: 10px 20px;">‚úì
                        Finish & Return Savings</button>
                </div>

                <div class="expense-form">
                    <h4>Event Transactions</h4>
                    <div class="nav-buttons" style="margin: 10px 0; justify-content: start;">
                        <button onclick="setEventType('income')" id="btnEvIncome" class="btn-small"
                            style="background: #00b894;">Add Fund (Taken)</button>
                        <button onclick="setEventType('expense')" id="btnEvExpense" class="btn-small"
                            style="background: #d63031; opacity: 0.5;">Cost (Spent)</button>
                    </div>
                    <input type="hidden" id="eventTypeInput" value="income">

                    <div class="form-group"><input type="text" id="eventTransDesc" placeholder="Description"></div>
                    <div class="form-group"><input type="number" id="eventTransAmount" placeholder="Amount"></div>
                    <button class="add-btn" onclick="addEventTransaction()" style="background: #333;">Update
                        Event</button>
                </div>

                <div class="expenses-list">
                    <div id="eventTransList"></div>
                </div>
            </div>
        </div>

        <div id="historyPage" style="display: none;">
            <div
                style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <input type="month" id="monthSelector"
                    style="padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                <div>
                    <button onclick="generatePDF()" class="btn-small btn-action">Download PDF</button>
                    <button onclick="exportToCSV()" class="btn-small btn-export">Export Excel/CSV</button>
                </div>
            </div>
            <div class="expenses-list">
                <h2 style="color: #00b894; border-left: 5px solid #00b894; padding-left: 10px;">Money Received</h2>
                <div id="moneyList"></div>
            </div>
            <div class="expenses-list">
                <h2 style="color: #d63031; border-left: 5px solid #d63031; padding-left: 10px;">Money Spent</h2>
                <div id="expensesList"></div>
            </div>
        </div>

        <div id="borrowPage" style="display: none;">
            <div class="summary-cards">
                <div class="summary-card card-borrowed">
                    <h3>I Owe (Dhar Korsi)</h3>
                    <p id="totalBorrowed">‡ß≥0</p>
                </div>
                <div class="summary-card card-lent">
                    <h3>Owed to Me (Pabo)</h3>
                    <p id="totalLent">‡ß≥0</p>
                </div>
            </div>
            <div class="expense-form">
                <h3 style="margin-bottom: 15px; color: #d35400;">Loan Manager</h3>
                <div class="form-group"><select id="borrowLendType">
                        <option value="borrowed">I Borrowed (Dhar nilam)</option>
                        <option value="lent">I Lent (Dhar dilam)</option>
                    </select></div>
                <div class="form-group"><input type="text" id="personName" placeholder="Person Name"></div>
                <div class="form-group"><input type="number" id="borrowLendAmount" placeholder="Amount"></div>
                <button class="add-btn" onclick="addBorrowLend()"
                    style="background: linear-gradient(135deg, #e17055 0%, #d35400 100%);">Add Transaction</button>
            </div>
            <div class="expenses-list">
                <h2 style="color: #e17055; border-left: 5px solid #e17055; padding-left: 10px;">Borrowed (Need to Repay)
                </h2>
                <div id="borrowedList"></div>
            </div>
            <div class="expenses-list">
                <h2 style="color: #0984e3; border-left: 5px solid #0984e3; padding-left: 10px;">Lent (Will Receive)</h2>
                <div id="lentList"></div>
            </div>
        </div>

        <div id="wishlistPage" style="display: none;">
            <div class="expense-form">
                <h3 style="color: #8e44ad; margin-bottom: 15px;">My Wishlist</h3>
                <div class="form-group"><input type="text" id="wishName" placeholder="Item Name"></div>
                <div class="form-group"><input type="number" id="wishPrice" placeholder="Price"></div>
                <div class="form-group"><input type="file" id="wishImage" accept="image/*"></div>
                <button class="add-btn" onclick="addToWishlist()" style="background: #8e44ad;">Add to Wishlist</button>
            </div>
            <div id="wishlistGrid" class="wishlist-grid"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG (Same as before)
        const firebaseConfig = {
            apiKey: "AIzaSyCi2k0RGi0OSYIIzjboE8GrzSwVGa1AiJo",
            authDomain: "student-finance-b137d.firebaseapp.com",
            projectId: "student-finance-b137d",
            storageBucket: "student-finance-b137d.firebasestorage.app",
            messagingSenderId: "987753111048",
            appId: "1:987753111048:web:611a437e84010a98887bbd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userData = { budget: 0, expenses: [], moneyReceived: [], borrowLend: [], wishlistItems: [], events: [] };

        // --- AUTH ---
        window.googleLogin = () => signInWithPopup(auth, provider).catch(err => alert("Login failed: " + err.message));
        window.logout = () => signOut(auth).then(() => window.location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userEmail').textContent = user.email;
                startDataSync(user.uid);
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        function startDataSync(uid) {
            onSnapshot(doc(db, "users", uid), (docSnap) => {
                if (docSnap.exists()) {
                    userData = { ...userData, ...docSnap.data() };
                    if (!userData.events) userData.events = [];
                    renderAll();
                    if (document.getElementById('eventsPage').style.display === 'block') renderEvents();
                    if (currentEventId && document.getElementById('eventDetailView').style.display === 'block') renderEventDetails();
                } else saveToCloud();
            });
        }

        function saveToCloud() {
            if (!currentUser) return;
            setDoc(doc(db, "users", currentUser.uid), userData);
        }

        // --- MAIN TRANSACTION LOGIC ---
        window.addMainTransaction = () => {
            const date = document.getElementById('mainDate').value;
            const type = document.getElementById('transactionType').value;
            const desc = document.getElementById('transactionDesc').value.trim();
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            if (!date || !desc || !amount) return;

            if (type === 'income') {
                userData.moneyReceived.push({ id: Date.now(), date, source: desc, amount });
                userData.budget += amount;
            } else {
                userData.expenses.push({ id: Date.now(), date, desc: desc, amount });
            }
            saveToCloud();
            document.getElementById('transactionDesc').value = '';
            document.getElementById('transactionAmount').value = '';
        };

        // --- EVENT / TOUR LOGIC ---
        let currentEventId = null;
        let eventTransType = 'income';

        window.createNewEvent = () => {
            const name = document.getElementById('newEventName').value;
            const budget = parseFloat(document.getElementById('newEventBudget').value) || 0;
            if (!name) return;

            const newEvent = {
                id: Date.now(),
                name: name,
                status: 'active',
                transactions: []
            };

            if (budget > 0) {
                newEvent.transactions.push({
                    id: Date.now() + 1,
                    type: 'income',
                    desc: 'Initial Fund Taken',
                    amount: budget,
                    date: new Date().toISOString().split('T')[0]
                });
            }

            userData.events.push(newEvent);
            saveToCloud();
            document.getElementById('newEventName').value = '';
            document.getElementById('newEventBudget').value = '';
        };

        window.renderEvents = () => {
            const active = userData.events.filter(e => e.status === 'active');
            const completed = userData.events.filter(e => e.status === 'completed');

            const eventCard = (e, color) => {
                const inc = e.transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                const exp = e.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                return `
                <div class="wishlist-card" onclick="openEventView(${e.id})" style="cursor:pointer; border-left: 5px solid ${color};">
                    <div class="wishlist-content">
                        <h3>${e.name}</h3>
                        <p>Funds Left: ‡ß≥${inc - exp}</p>
                        <small style="color:#666">${e.status === 'completed' ? 'Closed' : 'Active (Click to open)'}</small>
                    </div>
                </div>`;
            };

            document.getElementById('activeEventsList').innerHTML = active.map(e => eventCard(e, '#e17055')).join('');
            document.getElementById('completedEventsList').innerHTML = completed.map(e => eventCard(e, '#00b894')).join('');
        };

        window.openEventView = (id) => {
            currentEventId = id;
            document.getElementById('eventListView').style.display = 'none';
            document.getElementById('eventDetailView').style.display = 'block';
            renderEventDetails();
        };

        window.closeEventView = () => {
            currentEventId = null;
            document.getElementById('eventDetailView').style.display = 'none';
            document.getElementById('eventListView').style.display = 'block';
            renderEvents();
        };

        // --- NEW: FUNCTION TO DELETE ENTIRE EVENT ---
        window.deleteCurrentEvent = () => {
            if (!currentEventId) return;
            if (confirm("Are you sure you want to delete this ENTIRE event and all its data? This cannot be undone.")) {
                userData.events = userData.events.filter(e => e.id !== currentEventId);
                saveToCloud();
                closeEventView();
            }
        };

        window.setEventType = (type) => {
            eventTransType = type;
            document.getElementById('btnEvIncome').style.opacity = type === 'income' ? '1' : '0.5';
            document.getElementById('btnEvExpense').style.opacity = type === 'expense' ? '1' : '0.5';
        };

        window.addEventTransaction = () => {
            const desc = document.getElementById('eventTransDesc').value;
            const amount = parseFloat(document.getElementById('eventTransAmount').value);
            if (!desc || !amount || !currentEventId) return;

            const event = userData.events.find(e => e.id === currentEventId);
            event.transactions.push({
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                type: eventTransType,
                desc,
                amount
            });

            saveToCloud();
            document.getElementById('eventTransDesc').value = '';
            document.getElementById('eventTransAmount').value = '';
            renderEventDetails();
        };

        window.deleteEventTransaction = (eventId, transId) => {
            const event = userData.events.find(e => e.id === eventId);
            if (event) {
                event.transactions = event.transactions.filter(t => t.id !== transId);
                saveToCloud();
                renderEventDetails();
            }
        };

        window.renderEventDetails = () => {
            const event = userData.events.find(e => e.id === currentEventId);
            if (!event) return closeEventView();

            document.getElementById('currentEventTitle').textContent = event.name + (event.status === 'completed' ? ' (Closed)' : '');

            const inc = event.transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const exp = event.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);

            document.getElementById('eventBalance').textContent = `‡ß≥${inc - exp}`;
            document.getElementById('eventSpent').textContent = `‡ß≥${exp}`;

            document.getElementById('btnCompleteEvent').style.display = event.status === 'completed' ? 'none' : 'block';

            document.getElementById('eventTransList').innerHTML = event.transactions
                .sort((a, b) => b.id - a.id)
                .map(t => `
                    <div class="expense-item">
                        <div>${t.desc} <small>(${t.date})</small></div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="color: ${t.type === 'income' ? '#00b894' : '#d63031'}; font-weight:bold;">
                                ${t.type === 'income' ? '+' : '-'}‡ß≥${t.amount}
                            </span>
                            <button class="btn-small btn-delete" onclick="deleteEventTransaction(${event.id}, ${t.id})">Del</button>
                        </div>
                    </div>
                `).join('');
        };

        // --- EVENT COMPLETION LOGIC ---
        window.completeEvent = () => {
            const event = userData.events.find(e => e.id === currentEventId);
            const inc = event.transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const exp = event.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const remaining = inc - exp;

            let message = `Are you sure you want to CLOSE "${event.name}"?\n\n`;
            if (remaining > 0) message += `Savings of ‡ß≥${remaining} will be RETURNED to your main wallet.`;
            else if (remaining < 0) message += `Overspent amount ‡ß≥${Math.abs(remaining)} will be DEDUCTED from your main wallet.`;
            else message += `Perfectly balanced! No money returned or taken.`;

            if (confirm(message)) {
                const today = new Date().toISOString().split('T')[0];

                if (remaining > 0) {
                    userData.moneyReceived.push({
                        id: Date.now(),
                        date: today,
                        source: `Savings Return: ${event.name}`,
                        amount: remaining
                    });
                    userData.budget += remaining;
                }
                else if (remaining < 0) {
                    userData.expenses.push({
                        id: Date.now() + 1,
                        date: today,
                        desc: `Overspent in: ${event.name}`,
                        amount: Math.abs(remaining)
                    });
                }
                alert("Event Closed Successfully!");
            } else {
                return; // Cancelled
            }
            event.status = 'completed';
            saveToCloud();
            renderEventDetails();
        };

        window.generateEventPDF = () => {
            const event = userData.events.find(e => e.id === currentEventId);
            if (!event) return;
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            let y = 20;
            doc.setFontSize(16); doc.text(`Tour Report: ${event.name}`, 105, y, { align: 'center' }); y += 15;
            doc.setFontSize(12); doc.text(`Status: ${event.status.toUpperCase()}`, 20, y); y += 10;
            const inc = event.transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const exp = event.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            doc.text(`Total Fund Taken: ${inc}`, 20, y); y += 10;
            doc.text(`Total Spent: ${exp}`, 20, y); y += 10;
            doc.text(`Savings/Remaining: ${inc - exp}`, 20, y); y += 20;
            doc.setFontSize(14); doc.text("Details:", 20, y); y += 10;
            doc.setFontSize(10);
            event.transactions.forEach(t => {
                const prefix = t.type === 'income' ? '+' : '-';
                doc.text(`${t.date} | ${t.desc} | ${prefix}${t.amount}`, 20, y); y += 7;
                if (y > 280) { doc.addPage(); y = 20; }
            });
            doc.save(`${event.name}_Report.pdf`);
        };

        // --- BORROW/LEND LOGIC ---
        window.addBorrowLend = () => {
            const date = new Date().toISOString().split('T')[0];
            const type = document.getElementById('borrowLendType').value;
            const person = document.getElementById('personName').value.trim();
            const amount = parseFloat(document.getElementById('borrowLendAmount').value);
            if (!person || !amount) return;

            const item = { id: Date.now(), date, type, person, amount, paid: false };
            userData.borrowLend.push(item);

            if (type === 'borrowed') {
                userData.moneyReceived.push({ id: Date.now() + 1, date, source: `Dhar (Loan) from ${person}`, amount });
                userData.budget += amount;
            } else {
                userData.expenses.push({ id: Date.now() + 1, date, desc: `Dhar (Lent) to ${person}`, amount });
            }
            saveToCloud();
            document.getElementById('personName').value = '';
            document.getElementById('borrowLendAmount').value = '';
        };

        window.markAsPaid = (id) => {
            const item = userData.borrowLend.find(i => i.id === id);
            if (item && !item.paid) {
                item.paid = true;
                const today = new Date().toISOString().split('T')[0];
                if (item.type === 'borrowed') {
                    userData.expenses.push({ id: Date.now(), date: today, desc: `Repaid Loan: ${item.person}`, amount: item.amount });
                } else {
                    userData.moneyReceived.push({ id: Date.now(), date: today, source: `Loan Return: ${item.person}`, amount: item.amount });
                    userData.budget += item.amount;
                }
                saveToCloud();
            }
        };

        // --- WISHLIST & COMMON ---
        window.deleteItem = (type, id) => {
            if (type === 'money') {
                const i = userData.moneyReceived.find(x => x.id === id);
                if (i) { userData.budget -= i.amount; userData.moneyReceived = userData.moneyReceived.filter(x => x.id !== id); }
            }
            if (type === 'expense') userData.expenses = userData.expenses.filter(x => x.id !== id);
            if (type === 'borrow') userData.borrowLend = userData.borrowLend.filter(x => x.id !== id);
            if (type === 'wish') userData.wishlistItems = userData.wishlistItems.filter(x => x.id !== id);
            if (type === 'event') userData.events = userData.events.filter(x => x.id !== id);

            saveToCloud();
            if (document.getElementById('eventsPage').style.display === 'block') renderEvents();
        };

        window.addToWishlist = () => {
            const name = document.getElementById('wishName').value;
            const price = parseFloat(document.getElementById('wishPrice').value);
            const file = document.getElementById('wishImage').files[0];
            if (!name || !price) return;
            const saveWish = (img) => {
                userData.wishlistItems.push({ id: Date.now(), name, price, image: img, purchased: false });
                saveToCloud();
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => saveWish(e.target.result);
                reader.readAsDataURL(file);
            } else saveWish(null);
        };

        window.buyWishItem = (id) => {
            const item = userData.wishlistItems.find(i => i.id === id);
            if (item && !item.purchased) {
                item.purchased = true;
                const today = new Date().toISOString().split('T')[0];
                userData.expenses.push({ id: Date.now(), date: today, desc: `Wishlist Purchased: ${item.name}`, amount: item.price });
                saveToCloud();
            }
        };

        // --- EXPORT TO CSV ---
        window.exportToCSV = () => {
            const income = userData.moneyReceived.map(i => ({ date: i.date, type: 'Received', description: i.source, amount: i.amount }));
            const expenses = userData.expenses.map(e => ({ date: e.date, type: 'Spent', description: e.desc, amount: e.amount }));

            const allData = [...income, ...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            const headers = ["Date", "Type", "Description", "Amount"];
            const csvRows = [headers.join(",")];

            for (const row of allData) {
                const desc = `"${row.description.replace(/"/g, '""')}"`;
                csvRows.push([row.date, row.type, desc, row.amount].join(","));
            }

            const blob = new Blob([csvRows.join("\n")], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'student_finance_data.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        // --- RENDER & NAV ---
        function renderAll() {
            const totalSpent = userData.expenses.reduce((s, x) => s + x.amount, 0);
            const bal = userData.budget - totalSpent;
            const balEl = document.getElementById('remaining');
            balEl.textContent = `‡ß≥${bal.toFixed(2)}`;
            balEl.classList.toggle('negative', bal < 0);

            const debt = userData.borrowLend.filter(b => b.type === 'borrowed' && !b.paid).reduce((s, b) => s + b.amount, 0);
            document.getElementById('dashboardDebtBox').style.display = debt > 0 ? 'block' : 'none';
            document.getElementById('dashboardDebt').textContent = `‡ß≥${debt.toFixed(2)}`;

            document.getElementById('moneyList').innerHTML = userData.moneyReceived.length ? userData.moneyReceived.sort((a, b) => new Date(b.date) - new Date(a.date)).map(i => htmlItem(i.date, i.source, `+${i.amount}`, '#00b894', `deleteItem('money', ${i.id})`)).join('') : '<div style="text-align:center;color:#ccc">No records</div>';

            document.getElementById('expensesList').innerHTML = userData.expenses.length ? userData.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(i => htmlItem(i.date, i.desc, `-${i.amount}`, '#d63031', `deleteItem('expense', ${i.id})`)).join('') : '<div style="text-align:center;color:#ccc">No records</div>';

            const borrowed = userData.borrowLend.filter(b => b.type === 'borrowed');
            document.getElementById('borrowedList').innerHTML = borrowed.length ? borrowed.map(i => htmlBL(i, '#e74c3c')).join('') : '<div style="text-align:center;color:#ccc">No records</div>';

            const lent = userData.borrowLend.filter(b => b.type === 'lent');
            document.getElementById('lentList').innerHTML = lent.length ? lent.map(i => htmlBL(i, '#0984e3')).join('') : '<div style="text-align:center;color:#ccc">No records</div>';

            document.getElementById('totalBorrowed').textContent = `‡ß≥${debt.toFixed(2)}`;
            document.getElementById('totalLent').textContent = `‡ß≥${userData.borrowLend.filter(b => b.type === 'lent' && !b.paid).reduce((s, b) => s + b.amount, 0).toFixed(2)}`;

            document.getElementById('wishlistGrid').innerHTML = userData.wishlistItems.map(i => `
                <div class="wishlist-card ${i.purchased ? 'card-purchased' : ''}">
                    ${i.purchased ? '<div class="purchased-badge">PURCHASED</div>' : ''}
                    <div class="wishlist-img-box">${i.image ? `<img src="${i.image}">` : 'üì∑'}</div>
                    <div class="wishlist-content">
                        <b>${i.name}</b><br><span style="color:#667eea">‡ß≥${i.price}</span>
                        <div style="margin-top:10px; display:flex; gap:5px;">
                            ${!i.purchased ? `<button class="btn-buy" onclick="buyWishItem(${i.id})">Buy</button>` : ''}
                            <button class="btn-small btn-delete" onclick="deleteItem('wish', ${i.id})">Del</button>
                        </div>
                    </div>
                </div>`).join('');
        }

        const htmlItem = (date, text, amt, color, delFn) => `
            <div class="expense-item">
                <div><strong>${text}</strong><small>${date}</small></div>
                <div class="expense-amount" style="color:${color}">${amt}</div>
                <button class="btn-small btn-delete" onclick="${delFn}">Del</button>
            </div>`;

        const htmlBL = (i, color) => `
            <div class="expense-item" style="${i.paid ? 'opacity:0.6' : ''}">
                <div><strong>${i.person}</strong><small>${i.date}</small> <span class="badge ${i.paid ? 'badge-paid' : 'badge-borrowed'}">${i.paid ? 'PAID' : 'UNPAID'}</span></div>
                <div class="expense-amount" style="color:${color}">‡ß≥${i.amount}</div>
                <div>${!i.paid ? `<button class="btn-small btn-action" onclick="markAsPaid(${i.id})">Settled</button>` : ''}
                <button class="btn-small btn-delete" onclick="deleteItem('borrow', ${i.id})">Del</button></div>
            </div>`;

        window.showPage = (page) => {
            ['home', 'history', 'borrow', 'wishlist', 'events'].forEach(p => document.getElementById(p + 'Page').style.display = 'none');
            document.getElementById(page + 'Page').style.display = 'block';
            if (page === 'history') updatePDFMonth();
            if (page === 'events') renderEvents();
        };

        window.updatePDFMonth = () => {
            const now = new Date();
            if (!document.getElementById('monthSelector').value)
                document.getElementById('monthSelector').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        window.generatePDF = () => {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const month = document.getElementById('monthSelector').value;
            if (!month) return;
            const m = userData.moneyReceived.filter(x => x.date.startsWith(month));
            const e = userData.expenses.filter(x => x.date.startsWith(month));
            let y = 20; doc.text(`Wallet Report: ${month}`, 105, y, { align: 'center' }); y += 20;
            doc.text(`Received (In): ${m.reduce((s, x) => s + x.amount, 0)}`, 20, y); y += 10;
            doc.text(`Spent (Out): ${e.reduce((s, x) => s + x.amount, 0)}`, 20, y); y += 20;
            doc.text("Details:", 20, y); y += 10;
            [...m, ...e].forEach(i => { doc.text(`${i.date} ${i.source || i.desc}: ${i.amount}`, 20, y); y += 7; });
            doc.save(`wallet_report.pdf`);
        }

        // Init
        document.getElementById('mainDate').value = new Date().toISOString().split('T')[0];
    </script>
</body>

</html>