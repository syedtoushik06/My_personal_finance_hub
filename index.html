<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Wallet</title>
    <style>
        /* --- RESET & BASIC STYLES --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            overflow: hidden;
            position: relative;
        }

        /* --- LOGIN SCREEN --- */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            color: #333;
            width: 90%;
            max-width: 400px;
        }

        .btn-google {
            background: #4285F4;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn-google:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4);
        }

        /* --- APP STYLES --- */
        h1 {
            color: #3f2b96;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.2em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .btn-logout {
            background: #ff7675;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 11px;
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex: 1 1 auto;
            min-width: 80px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .nav-btn.home {
            background: linear-gradient(to right, #667eea, #764ba2);
        }

        .nav-btn.history {
            background: linear-gradient(to right, #11998e, #38ef7d);
        }

        .nav-btn.borrow {
            background: linear-gradient(to right, #ff9966, #ff5e62);
        }

        .nav-btn.wishlist {
            background: linear-gradient(to right, #8e44ad, #9b59b6);
        }

        .budget-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .budget-item h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .budget-item p {
            font-size: 36px;
            font-weight: bold;
        }

        .remaining.negative {
            color: #ffcccc !important;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .debt-alert-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 10px;
            border: 2px solid rgba(255, 100, 100, 0.5);
            animation: pulse 2s infinite;
        }

        .debt-text {
            color: #ffcccc;
            font-size: 24px !important;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 100, 100, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 100, 100, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 100, 100, 0);
            }
        }

        .expense-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #eef2f7;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .add-btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .expenses-list {
            margin-top: 20px;
        }

        .expense-item {
            background: white;
            border: 1px solid #eef2f7;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .expense-amount {
            font-size: 16px;
            font-weight: bold;
            margin: 0 10px;
            min-width: 70px;
            text-align: right;
        }

        .btn-small {
            padding: 8px 12px;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-delete {
            background: #ff7675;
        }

        .btn-action {
            background: #00b894;
        }

        .btn-export {
            background: #27ae60;
            margin-left: 5px;
        }

        .wishlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .wishlist-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }

        .wishlist-img-box {
            width: 100%;
            height: 120px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .wishlist-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .wishlist-content {
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .btn-buy {
            flex: 1;
            background: #8e44ad;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .purchased-badge {
            background: #00b894;
            color: white;
            padding: 5px;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .card-purchased {
            opacity: 0.7;
            filter: grayscale(100%);
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge-borrowed {
            background: #ffeaa7;
            color: #d35400;
        }

        .badge-lent {
            background: #74b9ff;
            color: #0984e3;
        }

        .badge-paid {
            background: #55efc4;
            color: #00b894;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            padding: 15px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .card-borrowed {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
        }

        .card-lent {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        /* --- MOBILE RESPONSIVE TWEAKS --- */
        @media screen and (max-width: 600px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }

            .user-info {
                position: relative;
                top: 0;
                right: 0;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 10px;
                margin-bottom: 15px;
            }

            .budget-item p {
                font-size: 28px;
            }

            .expense-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .expense-item>div:first-child {
                width: 100%;
                margin-bottom: 5px;
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
            }

            .expense-item>div:not(:first-child) {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .expense-amount {
                text-align: left;
                margin: 0;
            }

            .nav-buttons {
                gap: 5px;
            }

            .nav-btn {
                padding: 8px 10px;
                font-size: 11px;
            }

            button,
            select,
            input {
                min-height: 44px;
            }
        }
    </style>
</head>

<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="margin-bottom: 20px;">Student Wallet</h2>
            <p style="margin-bottom: 30px; color: #666;">Sign in to track your allowance and costs.</p>
            <button class="btn-google" onclick="googleLogin()">
                <svg width="20" height="20" viewBox="0 0 24 24" style="margin-right: 10px">
                    <path fill="currentColor"
                        d="M21.35 11.1h-9.17v2.98h5.24c-.27 1.67-1.65 4.54-5.24 4.54-3.15 0-5.73-2.55-5.73-5.73s2.55-5.73 5.73-5.73c1.38 0 2.62.5 3.58 1.45l2.4-2.4c-1.63-1.54-3.75-2.47-5.98-2.47-4.96 0-9 4.04-9 9s4.04 9 9 9c5.21 0 8.66-3.66 8.66-8.8 0-.68-.07-1.35-.15-1.99z" />
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <div class="user-info">
            <span id="userEmail">student@email.com</span>
            <button class="btn-logout" onclick="logout()">Sign Out</button>
        </div>

        <h1>üéì Toushik's Wallet</h1>

        <div class="nav-buttons">
            <button onclick="showPage('home')" class="nav-btn home">Dashboard</button>
            <button onclick="showPage('wishlist')" class="nav-btn wishlist">Wishlist</button>
            <button onclick="showPage('borrow')" class="nav-btn borrow">Loans</button>
            <button onclick="showPage('history')" class="nav-btn history">History</button>
        </div>

        <div id="homePage">
            <div style="text-align: center; margin-bottom: 20px;">
                <input type="date" id="mainDate"
                    style="padding: 10px; border: 1px solid #ccc; border-radius: 8px; width: 100%;">
            </div>
            <div class="budget-section">
                <div class="budget-grid">
                    <div class="budget-item">
                        <h3>My Pocket Balance</h3>
                        <p id="remaining">Loading...</p>
                    </div>
                    <div class="budget-item debt-alert-box" id="dashboardDebtBox" style="display: none;">
                        <h3>‚ö†Ô∏è You Owe</h3>
                        <p id="dashboardDebt" class="debt-text">‡ß≥0.00</p>
                    </div>
                </div>
            </div>
            <div class="expense-form">
                <h3 style="margin-bottom: 15px;">Wallet Entry</h3>
                <div class="form-group">
                    <select id="transactionType">
                        <option value="income">Money Received</option>
                        <option value="expense">Spent (Cost)</option>
                    </select>
                </div>
                <div class="form-group"><input type="text" id="transactionDesc"
                        placeholder="Description (e.g. Pocket money, Rickshaw)"></div>
                <div class="form-group"><input type="number" id="transactionAmount" placeholder="Amount"></div>
                <button class="add-btn" onclick="addMainTransaction()">Submit</button>
            </div>
        </div>

        <div id="historyPage" style="display: none;">
            <div
                style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px;">
                <input type="month" id="monthSelector"
                    style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%;">
                <div style="display: flex; gap: 5px;">
                    <button onclick="generatePDF()" class="btn-small btn-action" style="flex: 1;">Download PDF</button>
                    <button onclick="exportToCSV()" class="btn-small btn-export" style="flex: 1;">Export CSV</button>
                </div>
            </div>
            <div class="expenses-list">
                <h2 style="color: #00b894; border-left: 5px solid #00b894; padding-left: 10px; font-size: 1.2em;">Money
                    Received</h2>
                <div id="moneyList"></div>
            </div>
            <div class="expenses-list">
                <h2 style="color: #d63031; border-left: 5px solid #d63031; padding-left: 10px; font-size: 1.2em;">Money
                    Spent</h2>
                <div id="expensesList"></div>
            </div>
        </div>

        <div id="borrowPage" style="display: none;">
            <div class="summary-cards">
                <div class="summary-card card-borrowed">
                    <h3>I Owe</h3>
                    <p id="totalBorrowed">‡ß≥0</p>
                </div>
                <div class="summary-card card-lent">
                    <h3>Owed to Me</h3>
                    <p id="totalLent">‡ß≥0</p>
                </div>
            </div>
            <div class="expense-form">
                <h3 style="margin-bottom: 15px; color: #d35400;">Loan Manager</h3>
                <div class="form-group"><select id="borrowLendType">
                        <option value="borrowed">I Borrowed</option>
                        <option value="lent">I Lent</option>
                    </select></div>
                <div class="form-group"><input type="text" id="personName" placeholder="Person Name"></div>
                <div class="form-group"><input type="number" id="borrowLendAmount" placeholder="Amount"></div>
                <button class="add-btn" onclick="addBorrowLend()"
                    style="background: linear-gradient(135deg, #e17055 0%, #d35400 100%);">Add Transaction</button>
            </div>
            <div class="expenses-list">
                <h2 style="color: #e17055; border-left: 5px solid #e17055; padding-left: 10px; font-size: 1.1em;">
                    Borrowed (To Repay)
                </h2>
                <div id="borrowedList"></div>
            </div>
            <div class="expenses-list">
                <h2 style="color: #0984e3; border-left: 5px solid #0984e3; padding-left: 10px; font-size: 1.1em;">Lent
                    (To Receive)</h2>
                <div id="lentList"></div>
            </div>
        </div>

        <div id="wishlistPage" style="display: none;">
            <div class="expense-form">
                <h3 style="color: #8e44ad; margin-bottom: 15px;">My Wishlist</h3>
                <div class="form-group"><input type="text" id="wishName" placeholder="Item Name"></div>
                <div class="form-group"><input type="number" id="wishPrice" placeholder="Price"></div>
                <div class="form-group"><input type="file" id="wishImage" accept="image/*"></div>
                <button class="add-btn" onclick="addToWishlist()" style="background: #8e44ad;">Add to Wishlist</button>
            </div>
            <div id="wishlistGrid" class="wishlist-grid"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCi2k0RGi0OSYIIzjboE8GrzSwVGa1AiJo",
            authDomain: "student-finance-b137d.firebaseapp.com",
            projectId: "student-finance-b137d",
            storageBucket: "student-finance-b137d.firebasestorage.app",
            messagingSenderId: "987753111048",
            appId: "1:987753111048:web:611a437e84010a98887bbd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userData = { budget: 0, expenses: [], moneyReceived: [], borrowLend: [], wishlistItems: [] };

        // --- AUTH ---
        window.googleLogin = () => signInWithPopup(auth, provider).catch(err => alert("Login failed: " + err.message));
        window.logout = () => signOut(auth).then(() => window.location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                document.getElementById('userEmail').textContent = user.email;
                startDataSync(user.uid);
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        function startDataSync(uid) {
            onSnapshot(doc(db, "users", uid), (docSnap) => {
                if (docSnap.exists()) {
                    userData = { ...userData, ...docSnap.data() };
                    renderAll();
                } else saveToCloud();
            });
        }

        function saveToCloud() {
            if (!currentUser) return;
            setDoc(doc(db, "users", currentUser.uid), userData);
        }

        // --- MAIN TRANSACTION LOGIC ---
        window.addMainTransaction = () => {
            const date = document.getElementById('mainDate').value;
            const type = document.getElementById('transactionType').value;
            const desc = document.getElementById('transactionDesc').value.trim();
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            if (!date || !desc || !amount) return;

            if (type === 'income') {
                userData.moneyReceived.push({ id: Date.now(), date, source: desc, amount });
                userData.budget += amount;
            } else {
                userData.expenses.push({ id: Date.now(), date, desc: desc, amount });
            }
            saveToCloud();
            document.getElementById('transactionDesc').value = '';
            document.getElementById('transactionAmount').value = '';
        };

        // --- BORROW/LEND LOGIC ---
        window.addBorrowLend = () => {
            const today = getLocalToday();
            const type = document.getElementById('borrowLendType').value;
            const person = document.getElementById('personName').value.trim();
            const amount = parseFloat(document.getElementById('borrowLendAmount').value);
            if (!person || !amount) return;

            const item = { id: Date.now(), date: today, type, person, amount, paid: false };
            userData.borrowLend.push(item);

            if (type === 'borrowed') {
                userData.moneyReceived.push({ id: Date.now() + 1, date: today, source: `Loan from ${person}`, amount });
                userData.budget += amount;
            } else {
                userData.expenses.push({ id: Date.now() + 1, date: today, desc: `Lent to ${person}`, amount });
            }
            saveToCloud();
            document.getElementById('personName').value = '';
            document.getElementById('borrowLendAmount').value = '';
        };

        window.markAsPaid = (id) => {
            const item = userData.borrowLend.find(i => i.id === id);
            if (item && !item.paid) {
                item.paid = true;
                const today = getLocalToday();
                if (item.type === 'borrowed') {
                    userData.expenses.push({ id: Date.now(), date: today, desc: `Repaid Loan: ${item.person}`, amount: item.amount });
                } else {
                    userData.moneyReceived.push({ id: Date.now(), date: today, source: `Loan Return: ${item.person}`, amount: item.amount });
                    userData.budget += item.amount;
                }
                saveToCloud();
            }
        };

        // --- WISHLIST & COMMON ---
        window.deleteItem = (type, id) => {
            if (type === 'money') {
                const i = userData.moneyReceived.find(x => x.id === id);
                if (i) { userData.budget -= i.amount; userData.moneyReceived = userData.moneyReceived.filter(x => x.id !== id); }
            }
            if (type === 'expense') userData.expenses = userData.expenses.filter(x => x.id !== id);
            if (type === 'borrow') userData.borrowLend = userData.borrowLend.filter(x => x.id !== id);
            if (type === 'wish') userData.wishlistItems = userData.wishlistItems.filter(x => x.id !== id);

            saveToCloud();
        };

        window.addToWishlist = () => {
            const name = document.getElementById('wishName').value;
            const price = parseFloat(document.getElementById('wishPrice').value);
            const file = document.getElementById('wishImage').files[0];
            if (!name || !price) return;
            const saveWish = (img) => {
                userData.wishlistItems.push({ id: Date.now(), name, price, image: img, purchased: false });
                saveToCloud();
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => saveWish(e.target.result);
                reader.readAsDataURL(file);
            } else saveWish(null);
        };

        window.buyWishItem = (id) => {
            const item = userData.wishlistItems.find(i => i.id === id);
            if (item && !item.purchased) {
                item.purchased = true;
                const today = getLocalToday();
                userData.expenses.push({ id: Date.now(), date: today, desc: `Wishlist Purchased: ${item.name}`, amount: item.price });
                saveToCloud();
            }
        };

        // --- EXPORT TO CSV ---
        window.exportToCSV = () => {
            const income = userData.moneyReceived.map(i => ({ date: i.date, type: 'Received', description: i.source, amount: i.amount }));
            const expenses = userData.expenses.map(e => ({ date: e.date, type: 'Spent', description: e.desc, amount: e.amount }));

            const allData = [...income, ...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            const headers = ["Date", "Type", "Description", "Amount"];
            const csvRows = [headers.join(",")];

            for (const row of allData) {
                const desc = `"${row.description.replace(/"/g, '""')}"`;
                csvRows.push([row.date, row.type, desc, row.amount].join(","));
            }

            const blob = new Blob([csvRows.join("\n")], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'student_finance_data.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        // --- RENDER & NAV ---
        function renderAll() {
            const totalSpent = userData.expenses.reduce((s, x) => s + x.amount, 0);
            const bal = userData.budget - totalSpent;
            const balEl = document.getElementById('remaining');
            balEl.textContent = `‡ß≥${bal.toFixed(2)}`;
            balEl.classList.toggle('negative', bal < 0);

            const debt = userData.borrowLend.filter(b => b.type === 'borrowed' && !b.paid).reduce((s, b) => s + b.amount, 0);
            document.getElementById('dashboardDebtBox').style.display = debt > 0 ? 'block' : 'none';
            document.getElementById('dashboardDebt').textContent = `‡ß≥${debt.toFixed(2)}`;

            document.getElementById('moneyList').innerHTML = userData.moneyReceived.length ? userData.moneyReceived.sort((a, b) => new Date(b.date) - new Date(a.date)).map(i => htmlItem(i.date, i.source, `+${i.amount}`, '#00b894', `deleteItem('money', ${i.id})`)).join('') : '<div style="text-align:center;color:#ccc">No records</div>';

            document.getElementById('expensesList').innerHTML = userData.expenses.length ? userData.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(i => htmlItem(i.date, i.desc, `-${i.amount}`, '#d63031', `deleteItem('expense', ${i.id})`)).join('') : '<div style="text-align:center;color:#ccc">No records</div>';

            const borrowed = userData.borrowLend.filter(b => b.type === 'borrowed');
            document.getElementById('borrowedList').innerHTML = borrowed.length ? borrowed.map(i => htmlBL(i, '#e74c3c')).join('') : '<div style="text-align:center;color:#ccc">No records</div>';

            const lent = userData.borrowLend.filter(b => b.type === 'lent');
            document.getElementById('lentList').innerHTML = lent.length ? lent.map(i => htmlBL(i, '#0984e3')).join('') : '<div style="text-align:center;color:#ccc">No records</div>';

            document.getElementById('totalBorrowed').textContent = `‡ß≥${debt.toFixed(2)}`;
            document.getElementById('totalLent').textContent = `‡ß≥${userData.borrowLend.filter(b => b.type === 'lent' && !b.paid).reduce((s, b) => s + b.amount, 0).toFixed(2)}`;

            document.getElementById('wishlistGrid').innerHTML = userData.wishlistItems.map(i => `
                <div class="wishlist-card ${i.purchased ? 'card-purchased' : ''}">
                    ${i.purchased ? '<div class="purchased-badge">PURCHASED</div>' : ''}
                    <div class="wishlist-img-box">${i.image ? `<img src="${i.image}">` : 'üì∑'}</div>
                    <div class="wishlist-content">
                        <b>${i.name}</b><br><span style="color:#667eea">‡ß≥${i.price}</span>
                        <div style="margin-top:10px; display:flex; gap:5px;">
                            ${!i.purchased ? `<button class="btn-buy" onclick="buyWishItem(${i.id})">Buy</button>` : ''}
                            <button class="btn-small btn-delete" onclick="deleteItem('wish', ${i.id})">Del</button>
                        </div>
                    </div>
                </div>`).join('');
        }

        const htmlItem = (date, text, amt, color, delFn) => `
            <div class="expense-item">
                <div><strong>${text}</strong><small>${date}</small></div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div class="expense-amount" style="color:${color}">${amt}</div>
                    <button class="btn-small btn-delete" onclick="${delFn}">Del</button>
                </div>
            </div>`;

        const htmlBL = (i, color) => `
            <div class="expense-item" style="${i.paid ? 'opacity:0.6' : ''}">
                <div><strong>${i.person}</strong><small>${i.date}</small> <span class="badge ${i.paid ? 'badge-paid' : 'badge-borrowed'}">${i.paid ? 'PAID' : 'UNPAID'}</span></div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div class="expense-amount" style="color:${color}">‡ß≥${i.amount}</div>
                    <div>${!i.paid ? `<button class="btn-small btn-action" onclick="markAsPaid(${i.id})">Settled</button>` : ''}
                    <button class="btn-small btn-delete" onclick="deleteItem('borrow', ${i.id})">Del</button></div>
                </div>
            </div>`;

        window.showPage = (page) => {
            ['home', 'history', 'borrow', 'wishlist'].forEach(p => document.getElementById(p + 'Page').style.display = 'none');
            document.getElementById(page + 'Page').style.display = 'block';
            if (page === 'history') updatePDFMonth();
        };

        window.updatePDFMonth = () => {
            const now = new Date();
            if (!document.getElementById('monthSelector').value)
                document.getElementById('monthSelector').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        window.generatePDF = () => {
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const month = document.getElementById('monthSelector').value;
            if (!month) return;
            const m = userData.moneyReceived.filter(x => x.date.startsWith(month));
            const e = userData.expenses.filter(x => x.date.startsWith(month));
            let y = 20; doc.text(`Wallet Report: ${month}`, 105, y, { align: 'center' }); y += 20;
            doc.text(`Received (In): ${m.reduce((s, x) => s + x.amount, 0)}`, 20, y); y += 10;
            doc.text(`Spent (Out): ${e.reduce((s, x) => s + x.amount, 0)}`, 20, y); y += 20;
            doc.text("Details:", 20, y); y += 10;
            [...m, ...e].forEach(i => { doc.text(`${i.date} ${i.source || i.desc}: ${i.amount}`, 20, y); y += 7; });
            doc.save(`wallet_report.pdf`);
        }

        // --- LOCAL DATE HELPER ---
        function getLocalToday() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // Init - Set Local Date on Load
        document.getElementById('mainDate').value = getLocalToday();
    </script>
</body>

</html>